<!DOCTYPE html>
<html lang="de-DE">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DHBW - Unterschreiben</title>
        <link rel="stylesheet" href="/stylesheets/sass/custom/sign.css">
    </head>
    <body>
        <script>

            //code fragments from stackoverflow.com (altered)
            var canvas;
            var context;
            var isInBounds = false;
            var cWidth = 0, cHeight = 0;
            var prevX = 0, prevY = 0;
            var currX = 0, currY = 0;
            var flag = false, dot_flag = false;
            
            var canDownload = false, isCleared = true;

            window.addEventListener("resize", function (event){
                context.canvas.width = document.getElementById('sign-field').offsetWidth;
                context.canvas.height = document.getElementById('sign-field').offsetHeight;
            });

            window.onload = function(){
                canvas = document.getElementById('sign-field');
                context = canvas.getContext('2d');
                context.canvas.width = 850;
                context.canvas.height = 350;

                cHeight = canvas.getBoundingClientRect().bottom - canvas.getBoundingClientRect().top;
                cWidth = canvas.getBoundingClientRect().right - canvas.getBoundingClientRect().left;

                canvas.addEventListener("mousemove", function (e) {
                    process('move', e)
                }, false);
                canvas.addEventListener("mousedown", function (e) {
                    process('down', e)
                }, false);
                canvas.addEventListener("mouseup", function (e) {
                    process('up', e)
                }, false);
                canvas.addEventListener("mouseout", function (e) {
                    process('out', e)
                }, false);

                canvas.addEventListener("touchstart", function(e){
                    processTouch('down', e);
                }, false);
                canvas.addEventListener("touchend", function(e){
                    processTouch('up', e);
                }, false);
                canvas.addEventListener("touchmove", function(e){
                    processTouch('move', e);
                }, false);

                /*
                context.moveTo(50, 220);
                context.lineTo(800, 220);
                context.strokeStyle = "black";
                context.stroke();
                */
            }

            function process(action, e){
                if (action == 'down') {
                    isCleared = false;
                    prevX = currX;
                    prevY = currY;
                    currX = e.clientX - canvas.getBoundingClientRect().left;
                    currY = e.clientY - canvas.getBoundingClientRect().top;
            
                    flag = true;
                    dot_flag = true;
                    if (dot_flag) {
                        context.beginPath();
                        context.fillStyle = "black";
                        context.fillRect(currX, currY, 2, 2);
                        context.closePath();
                        dot_flag = false;
                    }
                }
                if (action == 'up' || action == "out") {
                    flag = false;
                }
                if (action == 'move') {
                    if (flag) {
                        isCleared = false;
                        prevX = currX;
                        prevY = currY;
                        currX = e.clientX - canvas.getBoundingClientRect().left;
                        currY = e.clientY - canvas.getBoundingClientRect().top;
                        draw();
                    }
                }
            }

            function processTouch(action, e){
                if (action == 'down') {
                    prevX = currX;
                    prevY = currY;
                    currX = e.offsetX ;//- canvas.getBoundingClientRect().left;
                    currY = e.offsetY ;//- canvas.getBoundingClientRect().top;
            
                    flag = true;
                    dot_flag = true;
                    if (dot_flag) {
                        context.beginPath();
                        context.fillStyle = "black";
                        context.fillRect(currX, currY, 2, 2);
                        context.closePath();
                        dot_flag = false;
                    }
                }
                if (action == 'up' || action == "out") {
                    flag = false;
                }
                if (action == 'move') {
                    if (flag) {
                        isCleared = false;
                        prevX = currX;
                        prevY = currY;
                        currX = e.touches['0'].clientX - canvas.getBoundingClientRect().left;
                        currY = e.touches['0'].clientY - canvas.getBoundingClientRect().top;
                        draw();
                    }
                }
            }

            function draw() {
                context.beginPath();
                context.moveTo(prevX, prevY);
                context.lineTo(currX, currY);
                context.strokeStyle = "black";
                context.lineWidth = 2;
                context.stroke();
                context.closePath();
            }

            function resetCanvas() {
                context.clearRect(0, 0, 850, 350);
                isCleared = true;
                canDownload = false;
            }

            function showPopup(){
                document.getElementById('popup').style.display = 'flex';
                context.canvas.width = document.getElementById('sign-field').offsetWidth;
                document.querySelector("html").style.overflow = "hidden";
                document.querySelector("body").style.overflow = "hidden";
            }
            
            function closePopup(){
                document.getElementById('popup').style.display = 'none';
                document.querySelector("html").style.overflow = "auto";
                document.querySelector("body").style.overflow = "auto";
            }

            function cancel(){
                resetCanvas();
                closePopup();
            }
            
            function displayImg(){
                var dataURL = canvas.toDataURL("image/png");
                document.getElementById('img-out').setAttribute("src", dataURL);
                document.getElementById('img-out').style.display = 'block';
                canDownload = true;
            }

            function exportImg(){
                //code from stackoverflow.com  (question #11112321)
                if(!canDownload){
                    alert("Es wurde keine Unterschrift erstellt!");
                    return;
                }
                let downloadLink = document.createElement('a');
                downloadLink.setAttribute('download', 'signature.png');
                canvas.toBlob(function(blob) {
                    let url = URL.createObjectURL(blob);
                    downloadLink.setAttribute('href', url);
                    downloadLink.click();
                });
            }

            function viewInBrowser(){
                if(!canDownload){
                    alert("Es wurde keine Unterschrift erstellt!");
                    return;
                }
                var dataURL = canvas.toDataURL("image/png");
                var newTab = window.open('about:blank','image from canvas');
                newTab.document.write("<img src='" + dataURL + "' alt='from canvas'/>");
                window.open(canvas.toDataURL('image/png'));
            }
        </script>

        <header>
        <img src="/images/logodhbw.svg" alt="W3Schools.com" width="300">
        <h3>DHBW Stuttgart - Unterschreiben</h3>
        <nav class="desktop-nav">
            <ul style="position: relative;">
                <li><a href="../">Startseite</a></li>
                <li><a href="weather.html">Wetter</a></li>
                <li class="link-sel"><a href="sign.html">Unterschreiben</a></li>
                <li><a href="rss.html">RSS-Feeds</a></li>
            </ul>
        </nav>
        <nav class="mobile-nav">
            <ul style="position: relative;">
              <li><a href="../"><img src="/images/svg/nav_icons/home-svgrepo-com.svg"></a></li>
              <li><a href="weather.html"><img src="/images/svg/nav_icons/cloud-weather-svgrepo-com.svg"></a></li>
              <li class="link-sel"><a href="#"><img src="/images/svg/nav_icons/signature-svgrepo-com.svg"></a></li>
              <li><a href="rss.html"><img src="/images/svg/nav_icons/feed-svgrepo-com.svg"></a></li>
            </ul>
          </nav>
        </header>

        <main>
            <section>
                <h4>Unterschreiben</h4>
                <button onclick="showPopup()" id="show-popup" class="main-btn">Signaturfeld &ouml;ffnen</button>
                <img id="img-out" style="width: 100%; height: auto; display: none;">
                <button id="download-img" class="btn-confirm main-btn" onclick="exportImg()">Herunterladen</button>
                <button class="btn-confirm main-btn" onclick="viewInBrowser()">Im Browser anzeigen</button>
            </section>
        </main>

        <div id="popup">
            <div id="sign-container">
                <span onclick="closePopup()" class="close-popup">X</span>
                <div id="toolbar">
                    <button class="tool btn-cancel" onclick="cancel()">Abbrechen</button>
                    <button class="tool btn-reset" onclick="resetCanvas()">Zur&uuml;cksetzen</button>
                    <button class="tool btn-confirm" onclick="displayImg()">Speichern</button>
                </div>
                <canvas id="sign-field"></canvas>
            </div>
        </div>

        <footer><p> Copyright &copy;2022 DHBW Stuttgart </p></footer>
    </body>
</html>